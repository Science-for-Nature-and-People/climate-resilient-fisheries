---
title: "CRf Heatmaps"
author: "Meghan Fletcher"
date: "2/15/2022"
output: 
  html_document:
    theme: flatly
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE, message = FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

```

# Load data

```{r}
library(here)
source(here("case_study_analysis","mf_clustering_analysis","00-load-libraries.R"))
load(here("case_study_analysis","mf_clustering_analysis","data","attribs.Rdata")) # from 01-prep-data.Rmd
load(here("case_study_analysis","mf_clustering_analysis","data","attributes_merged_clean.Rdata"))
```

######################################################################################################

# Attribute Score Dendrograms & Heatmap

```{r}
# Dendrogram based on hclust
score_clust <- attribs %>% 
  select(case_study, attribute_id, score) %>% 
  pivot_wider(names_from = attribute_id ,values_from = score)
 
score_hc <- score_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% # REVIEW
  as.matrix() %>% 
  dist() %>% hclust(method = "ward.D2")


plot(score_hc)

library(ape)
plot(as.phylo(score_hc), type = "unrooted", cex = 0.6,
     no.margin = TRUE)

library(ggdendro)
ggdendrogram(score_hc, rotate = TRUE, theme_dendro = FALSE)


# Plot a more finalized verson for the synthesisi paper

plot(score_hc, ylab="", yaxt="n", sub="", main="")
```


### Helpful resources
https://jokergoo.github.io/ComplexHeatmap-reference/book/a-single-heatmap.html#clustering-methods
https://www.biostars.org/p/273155/

```{r}
# Heatmap based on raw values
score_heatmap <- score_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Score")) 

score_heatmap
```


######################################################################################################

# Importance Dendrograms & Heatmap

```{r}
# Dendrogram based on hclust
importance_clust <- attribs %>% 
  select(case_study, attribute_id, numeric_importance) %>% 
  pivot_wider(names_from = attribute_id ,values_from = numeric_importance)
 
importance_hc <- importance_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% # REVIEW
  as.matrix() %>% 
  dist() %>% hclust(method = "ward.D2")


plot(importance_hc)

library(ape)
plot(as.phylo(importance_hc), type = "unrooted", cex = 0.6,
     no.margin = TRUE)

library(ggdendro)
ggdendrogram(importance_hc, rotate = TRUE, theme_dendro = FALSE)


# Heatmaps based on hc
```


```{r}
# Heatmap based on raw values
importance_heatmap <- importance_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Importance")) 

importance_heatmap
```


######################################################################################################

# Data Quality Dendrograms & Heatmap

```{r}
# Dendrogram based on hclust
quality_clust <- attribs %>% 
  select(case_study, attribute_id, numeric_quality) %>% 
  pivot_wider(names_from = attribute_id ,values_from = numeric_quality)
 
quality_hc <- quality_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% # REVIEW
  as.matrix() %>% 
  dist() %>% hclust(method = "ward.D2")


plot(quality_hc)

library(ape)
plot(as.phylo(quality_hc), type = "unrooted", cex = 0.6,
     no.margin = TRUE)

library(ggdendro)
ggdendrogram(quality_hc, rotate = TRUE, theme_dendro = FALSE)


# Heatmaps based on hc
```


```{r}
# Heatmap based on raw values
quality_heatmap <- quality_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Data Quality")) 

quality_heatmap
```


#############################################################################################

# Heatmap Grouping by Case Clusters
Create heatmaps using the clusters that came out of the circular diagrams that Whitney had created. Do this for both score and importance.

## Attribute Score Groupings Heatmaps

```{r}
# 1. Prep the data to separate out the appropriate cases for score grouping
# 2. create heatmaps of the different groupings

# Tokunaga, Hollowed, Mills, Free
KT_AH_KM_CF_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Tokunaga", "Hollowed", "Mills", "Free")) %>% 
  pivot_wider(names_from = attribute,values_from = official_score)

KT_AH_KM_CF_heatmap <- KT_AH_KM_CF_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Tokunaga, Hollowed, Mills & Free Heatmap")) 

KT_AH_KM_CF_heatmap

#Pecl, Kleisner, Golden
GP_KK_CG_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Pecl", "Kleisner", "Golden")) %>% 
  pivot_wider(names_from = attribute,values_from = official_score)

GP_KK_CG_heatmap <- GP_KK_CG_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Pecl, Kleisner & Free Heatmap")) 

GP_KK_CG_heatmap


#Eurich, Aguion
JE_AA_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Eurich", "Aguion")) %>% 
  pivot_wider(names_from = attribute,values_from = official_score)

JE_AA_heatmap <- JE_AA_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Eurich & Aguion Heatmap")) 

JE_AA_heatmap


#Friedmen, Zhoa, Lau, Westfall
WF_LZ_JL_KW_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Friedman", "Zhoa", "Lau", "Westfall")) %>% 
  pivot_wider(names_from = attribute,values_from = official_score)

WF_LZ_JL_KW_heatmap <- WF_LZ_JL_KW_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Friedman, Zhao, Lau & Westfall Heatmap")) 

WF_LZ_JL_KW_heatmap


#Dickey-Collas, Mason
```

```{r}
# Prep the data to separate out the appropriate cases for importance grouping

#Hollowed, Friedman, Pecl
AH_WF_GP_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, numeric_importance) %>% 
  filter(case_study %in% c("Friedman", "Hollowed", "Pecl")) %>% 
  pivot_wider(names_from = attribute, values_from = numeric_importance)

AH_WF_GP_heatmap <- AH_WF_GP_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Hollowed, Friedman & Pecl Heatmap")) 

AH_WF_GP_heatmap

#Zhao, Kleisner
LZ_KK_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, numeric_importance) %>% 
  filter(case_study %in% c("Zhao", "Kleisner")) %>% 
  pivot_wider(names_from = attribute, values_from = numeric_importance)

LZ_KK_heatmap <- LZ_KK_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Zhao & Kleisner Heatmap")) 

LZ_KK_heatmap

#Tokunaga, Lau
KT_JL_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, numeric_importance) %>% 
  filter(case_study %in% c("Tokunaga", "Lau")) %>% 
  pivot_wider(names_from = attribute, values_from = numeric_importance)

KT_JL_heatmap <- KT_JL_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Tokunaga & Lau Heatmap")) 

KT_JL_heatmap


#Free, Mason
CF_JM_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, numeric_importance) %>% 
  filter(case_study %in% c("Free", "Mason")) %>% 
  pivot_wider(names_from = attribute, values_from = numeric_importance)

CF_JM_heatmap <- CF_JM_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Free & Mason Heatmap")) 

CF_JM_heatmap


#Aguion, Eurich
AA_JE_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, numeric_importance) %>% 
  filter(case_study %in% c("Aguion", "Eurich")) %>% 
  pivot_wider(names_from = attribute, values_from = numeric_importance)

AA_JE_heatmap <- AA_JE_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Aguion & Eurich Heatmap")) 

AA_JE_heatmap
 

#Mills, Golden
KM_CG_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, numeric_importance) %>% 
  filter(case_study %in% c("Mills", "Golden")) %>% 
  pivot_wider(names_from = attribute, values_from = numeric_importance)

KM_CG_heatmap <- KM_CG_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Mills & Golden Heatmap")) 

KM_CG_heatmap



#Dickey-Collas and Westfall are stand-alone cases
```


#############################################################################################################

# Heatmap Grouping by Fishery Scale

## Attribute Score: Small-scale vs. Large-scale

```{r}
# Small-scale fisheres: Aguion, Eurich, Free, Friedman, Golden, Kleisner, Lau, Mills, Tokunaga, Zhao

# 1. Create the datasets
# 2. Create the heatmaps

small_scale_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Aguion", "Eurich", "Free","Friedman", "Golden", "Kleisner", "Lau", "Mills", "Tokunaga", "Zhao")) %>% 
  pivot_wider(names_from = attribute,values_from = official_score)

small_scale_heatmap <- small_scale_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Small-scale Attribute Score Heatmap")) 

small_scale_heatmap


# Large-scale fisheries: Dickey-Collas, Hollowed, Mason, Pecl, Westfall

large_scale_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Dickey_Collas", "Hollowed", "Mason","Pecl", "Westfall")) %>% 
  pivot_wider(names_from = attribute,values_from = official_score)

large_scale_heatmap <- large_scale_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Large-scale Attribute Score Heatmap")) 

large_scale_heatmap
```


## Importance: Small-scale vs. Large-scale

```{r}
# Small-scale fisheres: Aguion, Eurich, Free, Friedman, Golden, Kleisner, Lau, Mills, Tokunaga, Zhao

# 1. Create the datasets
# 2. Create the heatmaps

small_importance_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, numeric_importance) %>% 
  filter(case_study %in% c("Aguion", "Eurich", "Free","Friedman", "Golden", "Kleisner", "Lau", "Mills", "Tokunaga", "Zhao")) %>% 
  pivot_wider(names_from = attribute,values_from = numeric_importance)

small_importance_heatmap <- small_importance_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Small-scale Importance Heatmap")) 

small_importance_heatmap


# Large-scale fisheries: Dickey-Collas, Hollowed, Mason, Pecl, Westfall

large_importance_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, numeric_importance) %>% 
  filter(case_study %in% c("Dickey_Collas", "Hollowed", "Mason","Pecl", "Westfall")) %>% 
  pivot_wider(names_from = attribute,values_from = numeric_importance)

large_importance_heatmap <- large_importance_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Large-scale Importance Heatmap")) 

large_importance_heatmap
```


###############################################################################################

# Heatmap Grouping by Fishering Location (Coastal, Island, Pelagic)

## Attribute Score: Coastal vs. Island vs. Pelagic Location

```{r}
# Coastal Fisheries: Aguion, Free, Golden, Mills, Pecl, Tokunaga

coastal_score_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Aguion", "Free", "Golden", "Mills", "Pecl", "Tokunaga")) %>% 
  pivot_wider(names_from = attribute,values_from = official_score)

coastal_score_heatmap <- coastal_score_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Coastal Fisheries Attribute Score Heatmap")) 

coastal_score_heatmap

# Island Fisheries: Eurich, Friedman, Kleisner, Lau, Zhao

island_score_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Eurich", "Friedman", "Kleisner", "Lau", "Zhao")) %>% 
  pivot_wider(names_from = attribute,values_from = official_score)

island_score_heatmap <- island_score_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Island Fisheries Attribute Score Heatmap")) 

island_score_heatmap

# Pelagic Fisheries: Dickey-Collas, Hollowed, Mason, Westfall

pelagic_score_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Dickey_Collas", "Hollowed", "Mason", "Westfall")) %>% 
  pivot_wider(names_from = attribute,values_from = official_score)

pelagic_score_heatmap <- pelagic_score_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Pelagic Fisheries Attribute Score Heatmap")) 

pelagic_score_heatmap

```


## Importance: Coastal vs. Island vs. Pelagic

```{r}
# Coastal Fisheries: Aguion, Free, Golden, Mills, Pecl, Tokunaga

coastal_importance_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, numeric_importance) %>% 
  filter(case_study %in% c("Aguion", "Free", "Golden", "Mills", "Pecl", "Tokunaga")) %>% 
  pivot_wider(names_from = attribute,values_from = numeric_importance)

coastal_importance_heatmap <- coastal_importance_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Coastal Fisheries Importance Heatmap")) 

coastal_importance_heatmap

# Island Fisheries: Eurich, Friedman, Kleisner, Lau, Zhao

island_importance_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, numeric_importance) %>% 
  filter(case_study %in% c("Eurich", "Friedman", "Kleisner", "Lau", "Zhao")) %>% 
  pivot_wider(names_from = attribute,values_from = numeric_importance)

island_importance_heatmap <- island_importance_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Island Fisheries Importance Heatmap")) 

island_importance_heatmap

# Pelagic Fisheries: Dickey-Collas, Hollowed, Mason, Westfall

pelagic_importance_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, numeric_importance) %>% 
  filter(case_study %in% c("Dickey_Collas", "Hollowed", "Mason", "Westfall")) %>% 
  pivot_wider(names_from = attribute,values_from = numeric_importance)

pelagic_importance_heatmap <- pelagic_importance_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>%
  as.matrix() %>% t() %>% 
  Heatmap(clustering_distance_rows = "euclidean",
        clustering_method_rows ="ward.D2",
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = brewer.pal(9,"RdYlBu"),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Pelagic Fisheries Importance Heatmap")) 

pelagic_importance_heatmap

```


##########################################################################################

# Heatmap Grouping by Case Clusters using **Actual Score**
Create heatmaps using the clusters that came out of the circular diagrams that Whitney had created. Do this for just score for now to see what this looks like compared to previous scaled heatmap diagrams.

## Attribute Score Groupings Heatmaps

```{r}
# 1. Prep the data to separate out the appropriate cases for score grouping
# 2. create heatmaps of the different groupings

# Create color pallette of choice
pal <- colorRampPalette(colors = c("#ffffb2", "#fecc5c", "#fd8d3c", "#e31a1c"))

### Create heatmaps based on raw values

# Tokunaga, Hollowed, Mills, Free
KT_AH_KM_CF_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Tokunaga", "Hollowed", "Mills", "Free")) %>% 
  pivot_wider(names_from = attribute, values_from = official_score) 

KT_AH_KM_CF_clust %>%
  column_to_rownames(var = "case_study") %>% 
  #mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% # REVIEW
  as.matrix() %>% t() %>% 
  Heatmap(
        cluster_rows = T,
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = pal(11),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Score (KT, AH, KM, CF) "))

#################################################################################

# Pecl, Kleisner, Godlen
GP_KK_CG_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Pecl", "Kleisner", "Golden")) %>% 
  pivot_wider(names_from = attribute, values_from = official_score) 

GP_KK_CG_clust %>%
  column_to_rownames(var = "case_study") %>% 
  #mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% # REVIEW
  as.matrix() %>% t() %>% 
  Heatmap(
        cluster_rows = T,
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = pal(11),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Score (GP, KK, CG)"))

#################################################################################

# Eurich, Aguion
JE_AA_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Eurich", "Aguion")) %>% 
  pivot_wider(names_from = attribute, values_from = official_score) 

JE_AA_clust %>%
  column_to_rownames(var = "case_study") %>% 
  #mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% # REVIEW
  as.matrix() %>% t() %>% 
  Heatmap(
        cluster_rows = T,
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = pal(11),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Score (JE, AA)"))

#################################################################################

# Dickey-Collas, Mason
MDC_JM_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Dickey_Collas", "Mason")) %>% 
  pivot_wider(names_from = attribute, values_from = official_score) 

MDC_JM_clust %>%
  column_to_rownames(var = "case_study") %>% 
  #mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% # REVIEW
  as.matrix() %>% t() %>% 
  Heatmap(
        cluster_rows = T,
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = pal(11),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Score (MD, JM)"))


################################################################################

# Friedman, Zhao, Lau, Westfall
WF_LZ_JL_KW_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Friedman", "Zhao", "Lau", "Westfall")) %>% 
  pivot_wider(names_from = attribute, values_from = official_score) 

WF_LZ_JL_KW_clust %>%
  column_to_rownames(var = "case_study") %>% 
  #mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% # REVIEW
  as.matrix() %>% t() %>% 
  Heatmap(
        cluster_rows = T,
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = pal(11),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Score (WF, LZ, JL, KW)"))



```

## Attribute Score Grouping by Fishery Scale

### Attribute Score: Small-scale vs. Large-scale

```{r}
# Small-scale fisheres: Aguion, Eurich, Free, Friedman, Golden, Kleisner, Lau, Mills, Tokunaga, Zhao

# 1. Create the datasets
# 2. Create the heatmaps

small_scale_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Aguion", "Eurich", "Free","Friedman", "Golden", "Kleisner", "Lau", "Mills", "Tokunaga", "Zhao")) %>%
  pivot_wider(names_from = attribute,values_from = official_score)

small_score_heatmap <- small_scale_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  #mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% # REVIEW
  as.matrix() %>% t() %>% 
  Heatmap(
        cluster_rows = T,
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = pal(11),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Score (Small-scale)")) 

small_score_heatmap

###################################################################################################

# Large-scale fisheries: Dickey-Collas, Hollowed, Mason, Pecl, Westfall

large_scale_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Dickey_Collas", "Hollowed", "Mason","Pecl", "Westfall")) %>% 
  pivot_wider(names_from = attribute,values_from = official_score)

large_score_heatmap <- large_scale_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  #mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% # REVIEW
  as.matrix() %>% t() %>% 
  Heatmap(
        cluster_rows = T,
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = pal(11),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Score (Large-scale)"))  

large_score_heatmap
```

#### Correlation plots for small-scale and large-scale fisheries

```{r}
library(corrplot)

# small-scale
small_scale_clust[is.na(small_scale_clust)] <- 0

small_scale_corr <- small_scale_clust %>% 
  column_to_rownames(var="case_study") 

S <- cor(small_scale_corr)

corrplot(S, method="color", tl.cex = 0.5)

# large-scale
large_scale_clust[is.na(large_scale_clust)] <- 0

large_scale_corr <- large_scale_clust %>% 
  column_to_rownames(var="case_study") 

L <- cor(large_scale_corr)

corrplot(L, method="color", tl.cex = 0.5)

## Because species diversity is the same across all case studies, the SD is 0 ad thus a correlaiton plot doesn't make sense for this dataset
```






## Attribute Score Grouping by Fishering Location (Coastal, Island, Pelagic)

### Attribute Score: Coastal vs. Island vs. Pelagic Location

```{r}
# Coastal Fisheries: Aguion, Free, Golden, Mills, Pecl, Tokunaga

coastal_score_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Aguion", "Free", "Golden", "Mills", "Pecl", "Tokunaga")) %>% 
  pivot_wider(names_from = attribute,values_from = official_score)

coastal_score_heatmap2 <- coastal_score_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  #mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% # REVIEW
  as.matrix() %>% t() %>% 
  Heatmap(
        cluster_rows = T,
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = pal(11),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Score (Coastal)"))  

coastal_score_heatmap2

# Island Fisheries: Eurich, Friedman, Kleisner, Lau, Zhao

island_score_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Eurich", "Friedman", "Kleisner", "Lau", "Zhao")) %>% 
  pivot_wider(names_from = attribute,values_from = official_score)

island_score_heatmap2 <- island_score_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  #mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% # REVIEW
  as.matrix() %>% t() %>% 
  Heatmap(
        cluster_rows = T,
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = pal(11),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Score (Island)"))  

island_score_heatmap2

# Pelagic Fisheries: Dickey-Collas, Hollowed, Mason, Westfall

pelagic_score_clust <- attributes_merged_clean %>% 
  select(case_study, attribute, official_score) %>% 
  filter(case_study %in% c("Dickey_Collas", "Hollowed", "Mason", "Westfall")) %>% 
  pivot_wider(names_from = attribute,values_from = official_score)

pelagic_score_heatmap2 <- pelagic_score_clust %>% 
  column_to_rownames(var = "case_study") %>% 
  #mutate(across(everything(),~scale(.x))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% # REVIEW
  as.matrix() %>% t() %>% 
  Heatmap(
        cluster_rows = T,
        clustering_distance_columns = "euclidean",
        clustering_method_columns = "ward.D2",
        col = pal(11),
        row_names_gp = gpar(fontsize = 8),
        column_names_gp = gpar(fontsize = 10),
        column_names_rot = 45,
        show_heatmap_legend = TRUE,
        heatmap_legend_param = list(title = "Score (Pelagic)"))  

pelagic_score_heatmap2

```



